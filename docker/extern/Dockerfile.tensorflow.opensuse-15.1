#
# Based on the article 'Tensorflow 2.x C++ API for object detection (inference)' at
#
#   https://medium.com/@reachraktim/using-the-new-tensorflow-2-x-c-api-for-object-detection-inference-ad4b7fd5fecc
#
# to build TensorFlow and it's C++ libraries.
#
# Example Usage
# -------------
#
# 1. Create a volume to store created TensorFlow C++ library
#
#    docker volume create tensorflow-cc
#
# 2. Create and execute a Docker container to store the TensorFlow C++ library inside the volume
#
#    docker run -v tensorflow-cc:/opt/tensorflow/lib tensorflow-cc:1.0
#
# 3. List Docker volumes
#
#    docker volume ls
#
# 4. Determine location of Docker volume
#
#    docker volume inspect tensorflow-cc
#
#    Look for an entry like ...
#
#    "Mountpoint": "/var/lib/docker/volumes/tensorflow-cc/_data"
#
#    ... and copy data from this location to your desired location.
#

FROM opensuse/leap:15.1

# environment variables
ENV PROTOCOL_BUFFERS_SOURCE=/protocol_buffers
ENV TENSORFLOW_SOURCE=/tensorflow
ENV TENSORFLOW_CC_LIB_DESTINATION=/opt/tensorflow/lib

# library versions
ENV TENSORFLOW_VERSION=2.4.1

# add devel:tools:building repository
RUN zypper --non-interactive addrepo https://download.opensuse.org/repositories/devel:tools:building/openSUSE_Leap_15.1/devel:tools:building.repo

RUN zypper --non-interactive --no-gpg-checks refresh

# install dependencies
RUN zypper --non-interactive install --no-recommends \
  python3-devel \
  python3-pip \
  python \
  git \
  wget \
  autoconf \
  automake \
  libtool \
  curl \
  make \
  gcc-c++ \
  unzip \
  patch \
  curl \
  gnupg \
  gzip \
  which \
  bazel3.4 \
  protobuf-devel

# update pip
RUN python3 -m pip install --upgrade pip

# install numpy, wheel and keras_preprocessing
RUN python3 -m pip install -U --user pip numpy wheel
RUN python3 -m pip install -U --user keras_preprocessing --no-deps

# checkout Git repository and build TensorFlow
RUN mkdir -p ${TENSORFLOW_SOURCE}

RUN git clone https://github.com/tensorflow/tensorflow.git ${TENSORFLOW_SOURCE}

WORKDIR ${TENSORFLOW_SOURCE}

RUN git checkout v${TENSORFLOW_VERSION}

ENV PYTHON_BIN_PATH=/usr/bin/python3
ENV PYTHON_LIB_PATH=/usr/lib/python3.6/site-packages
ENV TF_NEED_GCP=0
ENV TF_NEED_CUDA=0
ENV TF_NEED_HDFS=0
ENV TF_NEED_OPENCL=0
ENV TF_NEED_JEMALLOC=1
ENV TF_ENABLE_XLA=0
ENV TF_NEED_VERBS=0
ENV TF_CUDA_CLANG=0
ENV TF_NEED_MKL=0
ENV TF_DOWNLOAD_MKL=0
ENV TF_NEED_AWS=0
ENV TF_NEED_MPI=0
ENV TF_NEED_GDR=0
ENV TF_NEED_S3=0
ENV TF_NEED_OPENCL_SYCL=0
ENV TF_SET_ANDROID_WORKSPACE=0
ENV TF_NEED_COMPUTECPP=0
ENV GCC_HOST_COMPILER_PATH=/usr/bin/gcc
ENV CC_OPT_FLAGS="-march=native"
ENV TF_NEED_KAFKA=0
ENV TF_NEED_TENSORRT=0

RUN ./configure

RUN bazel build \
  --jobs=8 \
  --config=v2 \
  --copt=-O3 \
  --copt=-m64 \
  --copt=-march=native \
  --config=opt \
  --verbose_failures \
  //tensorflow:tensorflow_cc \
  //tensorflow:install_headers \
  //tensorflow:tensorflow \
  //tensorflow:tensorflow_framework \
  //tensorflow/tools/lib_package:libtensorflow

# collect data of TensorFlow's C++ library 
RUN mkdir -p ${TENSORFLOW_CC_LIB_DESTINATION}

RUN cp -r ${TENSORFLOW_SOURCE}/bazel-bin/tensorflow/* ${TENSORFLOW_CC_LIB_DESTINATION}/

WORKDIR ${TENSORFLOW_CC_LIB_DESTINATION}

# create additinal symbolic links for libtensorflow.so and libtensorflow_cc.so
RUN ln -s libtensorflow.so.${TENSORFLOW_VERSION} libtensorflow.so && \
    ln -s libtensorflow.so.${TENSORFLOW_VERSION} libtensorflow.so.2 && \
    ln -s libtensorflow_cc.so.${TENSORFLOW_VERSION} libtensorflow_cc.so && \
    ln -s libtensorflow_cc.so.${TENSORFLOW_VERSION} libtensorflow_cc.so.2
